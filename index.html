<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>活動總整理 - 視覺邏輯升級版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", "微軟正黑體", sans-serif; font-size: 16px; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .sticky-col-1 { position: sticky; left: 0; z-index: 40; background: white; }
        .sticky-col-2 { position: sticky; z-index: 30; background: white; }
        .sticky-col-3 { position: sticky; z-index: 30; background: #eff6ff; } 
        .sticky-header { position: sticky; top: 0; z-index: 50; }
        .sticky-intersect { position: sticky; top: 0; left: 0; z-index: 60; }
        th, td { border: 1px solid #e2e8f0; position: relative; }
        /* 確保按鈕層級高於凍結窗格 */
        .admin-btn { transition: all 0.2s; cursor: pointer !important; pointer-events: auto !important; position: relative; z-index: 100; }
        .admin-btn:hover { transform: scale(1.1); }
        .clickable-btn { cursor: pointer; pointer-events: auto; }
        /* 確保管理區域可點擊 */
        .admin-controls { position: relative; z-index: 100; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            const elementRef = useRef(null);
            useEffect(() => {
                if (window.lucide && elementRef.current) {
                    elementRef.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    i.style.pointerEvents = 'none';
                    elementRef.current.appendChild(i);
                    window.lucide.createIcons({ root: elementRef.current, attrs: { width: size, height: size, class: className } });
                }
            }, [name, size, className]);
            return <span ref={elementRef} className="inline-flex items-center justify-center pointer-events-none"></span>;
        };

        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, []);
            const bgClass = type === 'success' ? 'bg-emerald-600' : 'bg-red-600';
            return (
                <div className={`fixed bottom-5 right-5 ${bgClass} text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-3 animate-bounce z-[200]`}>
                    <Icon name={type === 'success' ? 'check-circle' : 'alert-circle'} size={20} />
                    {message}
                </div>
            );
        };

        const ConfirmModal = ({ title, message, confirmText = "確認刪除", confirmColor = "bg-red-600 hover:bg-red-700", onConfirm, onCancel }) => {
            return (
                <div className="fixed inset-0 z-[300] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform scale-100 animate-in zoom-in duration-200">
                        <div className="p-6 text-center">
                            <div className={`mx-auto flex items-center justify-center h-12 w-12 rounded-full mb-4 ${confirmColor.includes('blue') ? 'bg-blue-100' : 'bg-red-100'}`}>
                                <Icon name="alert-circle" size={24} className={confirmColor.includes('blue') ? 'text-blue-600' : 'text-red-600'} />
                            </div>
                            <h3 className="text-lg font-bold text-gray-900 mb-2">{title}</h3>
                            <p className="text-sm text-gray-500 whitespace-pre-line">{message}</p>
                        </div>
                        <div className="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse gap-2">
                            <button type="button" onClick={onConfirm} className={`w-full inline-flex justify-center rounded-xl border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white sm:ml-3 sm:w-auto sm:text-sm clickable-btn transition-colors ${confirmColor}`}>
                                {confirmText}
                            </button>
                            <button type="button" onClick={onCancel} className="mt-3 w-full inline-flex justify-center rounded-xl border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm clickable-btn transition-colors">
                                取消
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const generateId = () => 'id-' + Date.now().toString(36) + '-' + Math.random().toString(36).substr(2, 9);

            const initialDates = ["2025-07-05", "2025-07-31", "2025-08-28", "2025-09-11", "2025-09-18", "2025-10-02", "2025-10-15", "2025-10-23", "2025-11-05", "2025-11-27", "2025-12-18", "2025-12-24"];
            
            const getInitialActivities = () => {
                const raw = [
                    { name: "登入/簽到好禮", category: "獎勵", data: ["", "O", "", "", "", "", "O", "O", "", "O", "", "O"] },
                    { name: "打怪掉落", category: "戰鬥", data: ["O", "O", "O", "", "", "", "", "O", "", "O", "", "O"] },
                    { name: "兌換商店", category: "系統", data: ["O", "O", "O", "", "", "", "", "", "", "O", "", "O"] },
                    { name: "活動限定任務", category: "任務", data: ["O", "", "O", "O", "", "O", "", "O", "O", "O", "", ""] },
                    { name: "夥伴遠征加倍", category: "加倍", data: ["", "", "", "", "", "", "", "", "", "", "", "O"] },
                    { name: "組織捐獻加倍", category: "加倍", data: ["", "", "", "", "", "", "", "", "", "", "", "O"] },
                    { name: "活動/小遊戲額外獎勵", category: "小遊戲", data: ["", "", "", "", "", "O", "", "", "", "", "", ""] },
                    { name: "活動限定副本", category: "副本", data: ["", "", "", "", "", "", "O", "", "", "", "", ""] },
                    { name: "活動限定協力", category: "副本", data: ["", "", "", "", "", "", "", "", "", "O", "O", "O"] },
                    { name: "活動限定拼圖活動", category: "任務", data: ["", "", "", "", "", "", "", "O", "", "", "", "O"] },
                    { name: "美食歡樂送裝扮", category: "裝扮", data: ["", "", "", "", "", "", "", "", "", "", "O", ""] },
                    { name: "基督村裝扮", category: "裝扮", data: ["", "", "", "", "", "", "", "", "", "", "O", ""] },
                    { name: "心靈之器", category: "系統", data: ["", "", "", "", "", "", "", "", "", "", "", "O"] }
                ];
                return raw.map(a => ({...a, id: generateId()}));
            };

            const [dates, setDates] = useState(initialDates);
            const [activities, setActivities] = useState(() => getInitialActivities());
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedCategory, setSelectedCategory] = useState('全部');
            const [showManager, setShowManager] = useState(false);
            const [editSnapshot, setEditSnapshot] = useState(null);
            
            const [apiKey, setApiKey] = useState('');
            const [toast, setToast] = useState(null);
            const [confirmConfig, setConfirmConfig] = useState({ show: false, type: null, payload: null, title: '', message: '', confirmText: '確認', confirmColor: '' });

            const [editingActIndex, setEditingActIndex] = useState(null);
            const [editingActValue, setEditingActValue] = useState('');
            const [editingDateIndex, setEditingDateIndex] = useState(null);
            const [editingDateValue, setEditingDateValue] = useState('');

            const [newActivityName, setNewActivityName] = useState('');
            const [newActivityCategory, setNewActivityCategory] = useState('獎勵');
            const [newDate, setNewDate] = useState('');
            
            const [showAiModal, setShowAiModal] = useState(false);
            const [aiResult, setAiResult] = useState('');
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [showKeyInput, setShowKeyInput] = useState(false);
            const keyInputRef = useRef(null);

            const categories = ['全部', '獎勵', '戰鬥', '系統', '任務', '加倍', '副本', '裝扮', '小遊戲'];
            const colWidths = { name: 260, category: 110, total: 90 };

            useEffect(() => {
                const savedData = localStorage.getItem('activityDashboardData');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if(parsed.dates && parsed.activities) {
                            setDates(parsed.dates);
                            setActivities(parsed.activities.map(a => ({...a, id: a.id || generateId()})));
                        }
                    } catch (e) {}
                }
                const savedKey = localStorage.getItem('geminiApiKey');
                if (savedKey) setApiKey(savedKey);
            }, []);

            const showToast = (msg, type = 'success') => setToast({ message: msg, type });
            const persistData = (d, a) => { localStorage.setItem('activityDashboardData', JSON.stringify({ dates: d, activities: a })); };

            const toggleManager = () => {
                const nextState = !showManager;
                setShowManager(nextState);
                if (nextState) {
                    const snap = {};
                    activities.forEach(act => { snap[act.id] = [...act.data]; });
                    setEditSnapshot(snap);
                } else {
                    setEditSnapshot(null);
                }
            };

            const handleConfirmAction = () => {
                const { type, payload } = confirmConfig;
                if (type === 'deleteDate') {
                    const idx = payload;
                    setDates(prevDates => {
                        const nextDates = prevDates.filter((_, i) => i !== idx);
                        setActivities(prevActs => {
                            const nextActs = prevActs.map(act => ({ ...act, data: act.data.filter((_, i) => i !== idx) }));
                            persistData(nextDates, nextActs);
                            return nextActs;
                        });
                        return nextDates.filter((_, i) => i !== idx);
                    });
                    showToast("日期已成功刪除");
                } 
                else if (type === 'deleteActivity') {
                    const idx = payload;
                    setActivities(prev => {
                        const next = prev.filter((_, i) => i !== idx);
                        persistData(dates, next);
                        return next;
                    });
                    showToast("活動已成功刪除");
                }
                else if (type === 'toggleStatus') {
                    const { actIdx, dateIdx } = payload;
                    const updated = activities.map((act, i) => {
                        if (i === actIdx) {
                            const newData = [...act.data];
                            newData[dateIdx] = newData[dateIdx] === "O" ? "" : "O";
                            return { ...act, data: newData };
                        }
                        return act;
                    });
                    setActivities(updated);
                    persistData(dates, updated);
                    showToast("狀態已更新");
                }
                setConfirmConfig({ show: false, type: null, payload: null, title: '', message: '' });
            };

            const onDeleteDateClick = (idx) => {
                setConfirmConfig({ show: true, type: 'deleteDate', payload: idx, title: '刪除日期確認', message: `您確定要刪除「${dates[idx]}」嗎？`, confirmText: '確認刪除', confirmColor: 'bg-red-600 hover:bg-red-700' });
            };

            const onDeleteActivityClick = (idx) => {
                const actName = activities[idx]?.name || "此活動";
                setConfirmConfig({ show: true, type: 'deleteActivity', payload: idx, title: '刪除活動確認', message: `您確定要刪除「${actName}」嗎？`, confirmText: '確認刪除', confirmColor: 'bg-red-600 hover:bg-red-700' });
            };

            const toggleStatusClick = (actIdx, dateIdx) => {
                if (!showManager) return;
                const currentStatus = activities[actIdx].data[dateIdx];
                const action = currentStatus === "O" ? "取消勾選" : "勾選";
                const actName = activities[actIdx].name;
                const dateStr = dates[dateIdx];
                setConfirmConfig({ show: true, type: 'toggleStatus', payload: { actIdx, dateIdx }, title: '變更狀態確認', message: `您確定要 ${action} 這項紀錄嗎？\n(${actName} - ${dateStr})`, confirmText: '確認變更', confirmColor: 'bg-blue-600 hover:bg-blue-700' });
            };

            const handleExport = () => {
                const dataStr = JSON.stringify({ dates, activities }, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `活動備份_${new Date().toISOString().split('T')[0]}.json`;
                a.click(); showToast("備份檔案已下載");
            };
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const parsed = JSON.parse(event.target.result);
                        if (parsed.dates && parsed.activities) {
                            setDates(parsed.dates);
                            setActivities(parsed.activities.map(a => ({...a, id: a.id || generateId()})));
                            persistData(parsed.dates, parsed.activities);
                            showToast("資料還原成功！");
                        }
                    } catch (err) { showToast("無法讀取檔案", "error"); }
                };
                reader.readAsText(file);
                e.target.value = '';
            };
            const saveApiKey = (key) => { setApiKey(key); try { localStorage.setItem('geminiApiKey', key); } catch(e){} setShowKeyInput(false); showToast("API Key 已儲存"); };
            const callGemini = async (prompt, systemPrompt) => {
                if (!apiKey) { setShowKeyInput(true); return; }
                setIsAiLoading(true); setAiResult(''); setShowAiModal(true);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } })
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    setAiResult(data.candidates?.[0]?.content?.parts?.[0]?.text || "無回應");
                } catch (e) { setAiResult(`錯誤：${e.message}`); } finally { setIsAiLoading(false); }
            };
            const handleAiAnnouncement = (dateIdx) => {
                const dateStr = dates[dateIdx];
                const activeActivities = activities.filter(act => act.data[dateIdx] === "O").map(act => `【${act.category}】${act.name}`);
                if (activeActivities.length === 0) { showToast("該日期沒有活動", "error"); return; }
                const prompt = `在 ${dateStr} 這天，我們準備了以下活動：${activeActivities.join('、')}。請寫一段吸引人的遊戲公告。`;
                callGemini(prompt, "你是一位社群經營專家。");
            };
            const handleAddActivity = (e) => {
                e.preventDefault();
                if (!newActivityName) return;
                const newActs = [...activities, { id: generateId(), name: newActivityName, category: newActivityCategory, data: new Array(dates.length).fill("") }];
                setActivities(newActs); setNewActivityName(''); persistData(dates, newActs); showToast("活動已新增");
            };
            const startEditActivity = (idx, val) => { setEditingActIndex(idx); setEditingActValue(val); };
            const saveActivityName = () => { if (editingActIndex === null) return; const updated = [...activities]; updated[editingActIndex].name = editingActValue; setActivities(updated); persistData(dates, updated); setEditingActIndex(null); showToast("名稱已更新"); };
            const startEditDate = (idx, val) => { setEditingDateIndex(idx); setEditingDateValue(val); };
            const saveDateValue = () => { if (editingDateIndex === null) return; const updatedDates = [...dates]; updatedDates[editingDateIndex] = editingDateValue; setDates(updatedDates); persistData(updatedDates, activities); setEditingDateIndex(null); showToast("日期已更新"); };
            const handleAddDate = (e) => {
                e.preventDefault(); if (!newDate) return;
                const combined = [...dates, newDate].sort();
                const newIdx = combined.indexOf(newDate);
                const updatedActs = activities.map(act => { const newData = [...act.data]; newData.splice(newIdx, 0, ""); return { ...act, data: newData }; });
                setDates(combined); setActivities(updatedActs); setNewDate(''); persistData(combined, updatedActs); showToast("日期已新增");
            };

            const toggleStatus = (actIdx, dateIdx) => {
                if (!showManager) return;
                const updated = [...activities];
                updated[actIdx].data[dateIdx] = updated[actIdx].data[dateIdx] === "O" ? "" : "O";
                setActivities(updated);
                persistData(dates, updated);
            };

            const filteredActivities = useMemo(() => {
                return activities
                    .map((act, index) => ({ ...act, originalIndex: index }))
                    .filter(act => {
                        const matchesSearch = act.name.toLowerCase().includes(searchTerm.toLowerCase());
                        const matchesCategory = selectedCategory === '全部' || act.category === selectedCategory;
                        return matchesSearch && matchesCategory;
                    });
            }, [activities, searchTerm, selectedCategory]);

            const stats = useMemo(() => {
                const totalActs = activities.length;
                const totalChecks = activities.reduce((acc, act) => acc + act.data.filter(c => c === 'O').length, 0);
                const activeDates = dates.length;
                return { totalActs, totalChecks, activeDates };
            }, [activities, dates]);

            const getCategoryColor = (cat) => {
                const colors = { '獎勵': 'bg-blue-100 text-blue-700 border-blue-200', '戰鬥': 'bg-red-100 text-red-700 border-red-200', '系統': 'bg-slate-100 text-slate-700 border-slate-200', '任務': 'bg-emerald-100 text-emerald-700 border-emerald-200', '加倍': 'bg-amber-100 text-amber-700 border-amber-200', '副本': 'bg-purple-100 text-purple-700 border-purple-200', '裝扮': 'bg-pink-100 text-pink-700 border-pink-200', '小遊戲': 'bg-orange-100 text-orange-700 border-orange-200' };
                return colors[cat] || 'bg-gray-100 text-gray-700 border-gray-200';
            };
            const getTabStyle = (cat, isSelected) => {
                if (cat === '全部') return isSelected ? `bg-slate-800 text-white border-slate-800` : `bg-white text-slate-600 border-slate-200 hover:bg-slate-50`;
                const colorClass = getCategoryColor(cat);
                return isSelected ? `${colorClass.replace('bg-', 'bg-').replace('text-', 'text-').replace('100', '600').replace('700', 'white').replace('200', '600')} shadow-md` : `bg-white text-slate-600 border-slate-200 hover:bg-slate-50`;
            };

            const getCheckColorClass = (act, cIdx, isNew, category) => {
                if (showManager) {
                    return isNew ? "text-emerald-500 fill-emerald-50" : "text-slate-400 fill-slate-100";
                } else {
                    const map = {
                        '獎勵': 'text-blue-600 fill-blue-50',
                        '戰鬥': 'text-red-600 fill-red-50',
                        '系統': 'text-slate-600 fill-slate-50',
                        '任務': 'text-emerald-600 fill-emerald-50',
                        '加倍': 'text-amber-600 fill-amber-50',
                        '副本': 'text-purple-600 fill-purple-50',
                        '裝扮': 'text-pink-600 fill-pink-50',
                        '小遊戲': 'text-orange-600 fill-orange-50'
                    };
                    return map[category] || 'text-blue-600 fill-blue-50';
                }
            };

            return (
                <div className="min-h-screen p-4 md:p-8">
                    <div className="max-w-[1600px] mx-auto">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex items-center justify-between"><div><p className="text-slate-500 text-sm font-bold">總活動項目</p><h2 className="text-3xl font-black text-slate-800">{stats.totalActs}</h2></div><div className="p-3 bg-blue-50 rounded-full text-blue-600"><Icon name="layers" size={24} /></div></div>
                            <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex items-center justify-between"><div><p className="text-slate-500 text-sm font-bold">涵蓋日期數</p><h2 className="text-3xl font-black text-slate-800">{stats.activeDates}</h2></div><div className="p-3 bg-emerald-50 rounded-full text-emerald-600"><Icon name="calendar-days" size={24} /></div></div>
                            <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex items-center justify-between"><div><p className="text-slate-500 text-sm font-bold">總場次標記</p><h2 className="text-3xl font-black text-slate-800">{stats.totalChecks}</h2></div><div className="p-3 bg-purple-50 rounded-full text-purple-600"><Icon name="check-circle-2" size={24} /></div></div>
                        </div>

                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-6">
                            <div className="flex flex-col xl:flex-row xl:items-center justify-between gap-6">
                                <div><h1 className="text-2xl font-bold text-slate-800 flex items-center gap-3"><Icon name="calendar" size={28} className="text-blue-600" />活動總整理<button onClick={() => callGemini("分析活動排程健康度", "專家")} className="text-xs bg-purple-100 text-purple-600 px-3 py-1 rounded-full hover:bg-purple-200 font-bold flex items-center gap-1"><Icon name="sparkles" size={14} /> AI 健檢</button></h1><p className="text-slate-500 mt-1 text-sm">視覺升級版：檢視模式跟隨分類色，編輯模式新增為綠色。</p></div>
                                <div className="flex flex-wrap items-center gap-3">
                                    <div className="relative flex-1 xl:flex-none"><Icon name="search" size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" /><input type="text" placeholder="搜尋活動..." className="pl-10 pr-4 py-2.5 bg-slate-50 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 w-full xl:w-64" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /></div>
                                    <button onClick={handleExport} className="px-4 py-2.5 rounded-xl font-bold border hover:bg-slate-50 flex items-center gap-2 text-slate-600"><Icon name="download" size={18}/> 備份</button>
                                    <label className="px-4 py-2.5 rounded-xl font-bold border hover:bg-slate-50 flex items-center gap-2 text-slate-600 cursor-pointer"><Icon name="upload" size={18}/> 還原<input type="file" accept=".json" onChange={handleImport} className="hidden" /></label>
                                    <button onClick={toggleManager} className={`px-5 py-2.5 rounded-xl font-bold border transition-all flex items-center gap-2 ${showManager ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-slate-600 border-slate-200'}`}><Icon name="settings-2" size={18} /> 管理面板</button>
                                </div>
                            </div>
                            {showManager && (
                                <div className="mt-6 pt-6 border-t grid grid-cols-1 md:grid-cols-2 gap-6 animate-in slide-in-from-top-4 duration-300">
                                    <div className="bg-slate-50 p-5 rounded-xl border border-slate-200"><h3 className="font-bold text-slate-700 mb-3 flex justify-between"><span className="flex items-center gap-2"><Icon name="plus" size={18} /> 新增活動</span> <button onClick={() => callGemini("建議活動", "企劃")} className="text-xs text-purple-600 flex items-center gap-1 hover:underline"><Icon name="sparkles" size={12}/> AI 靈感</button></h3><div className="flex gap-2"><input type="text" value={newActivityName} onChange={e => setNewActivityName(e.target.value)} placeholder="名稱" className="flex-1 p-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-400"/><select value={newActivityCategory} onChange={e => setNewActivityCategory(e.target.value)} className="p-2 border rounded-lg text-sm bg-white outline-none">{categories.filter(c => c !== '全部').map(c => <option key={c} value={c}>{c}</option>)}</select><button onClick={handleAddActivity} className="bg-blue-600 text-white px-4 rounded-lg font-bold text-sm hover:bg-blue-700">新增</button></div></div>
                                    <div className="bg-slate-50 p-5 rounded-xl border border-slate-200"><h3 className="font-bold text-slate-700 mb-3 flex gap-2"><Icon name="calendar" size={18} /> 新增日期</h3><div className="flex gap-2"><input type="date" value={newDate} onChange={e => setNewDate(e.target.value)} className="flex-1 p-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-emerald-400"/><button onClick={handleAddDate} className="bg-emerald-600 text-white px-4 rounded-lg font-bold text-sm hover:bg-emerald-700">新增</button></div></div>
                                </div>
                            )}
                        </div>

                        <div className="flex gap-2 mb-6 overflow-x-auto no-scrollbar pb-2">
                            {categories.map(cat => <button key={cat} onClick={() => setSelectedCategory(cat)} className={`px-4 py-1.5 rounded-full text-sm font-bold border transition-all whitespace-nowrap ${getTabStyle(cat, selectedCategory === cat)}`}>{cat}</button>)}
                        </div>

                        <div className="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden" key={`table-wrapper-${dates.length}`}>
                            <div className="overflow-auto max-h-[650px]">
                                <table className="w-full border-separate border-spacing-0 text-left">
                                    <thead>
                                        <tr>
                                            <th className="sticky-intersect bg-slate-100 px-6 py-4 font-bold text-slate-700 border-r border-b" style={{ minWidth: colWidths.name }}>活動名稱</th>
                                            <th className="sticky-header bg-slate-100 px-5 py-4 font-bold text-slate-700 border-r border-b sticky-col-2" style={{ left: colWidths.name, minWidth: colWidths.category }}>分類</th>
                                            <th className="sticky-header px-5 py-4 text-center font-bold text-blue-800 border-r-2 border-b bg-blue-50 sticky-col-3" style={{ left: colWidths.name + colWidths.category, minWidth: colWidths.total }}>總數</th>
                                            {dates.map((d, i) => (
                                                <th key={d} className="sticky-header bg-slate-100 px-5 py-4 text-center font-bold text-slate-500 min-w-[130px] border-b border-r last:border-r-0">
                                                    <div className="flex flex-col items-center justify-center w-full">
                                                        {editingDateIndex === i ? (
                                                            <div className="flex items-center gap-1"><input className="w-24 text-xs p-1 border rounded outline-none focus:ring-2 focus:ring-blue-400" value={editingDateValue} onChange={e => setEditingDateValue(e.target.value)} autoFocus /><button onClick={saveDateValue} className="text-emerald-500 p-1 hover:bg-emerald-50 rounded"><Icon name="check" size={14}/></button></div>
                                                        ) : (
                                                            <div className="flex flex-col items-center justify-center w-full">
                                                                <span className="mb-1 text-sm">{d.replace(/-/g, '/')}</span>
                                                                {showManager && <div className="flex items-center gap-2 mt-1 admin-controls"><button onClick={() => startEditDate(i, d)} className="admin-btn text-blue-500 hover:bg-blue-100 p-1.5 rounded" title="編輯日期"><Icon name="pencil" size={14}/></button><button onClick={() => onDeleteDateClick(i)} className="admin-btn text-red-500 hover:bg-red-100 p-1.5 rounded" title="刪除日期"><Icon name="trash-2" size={14}/></button></div>}
                                                                {!showManager && <button onClick={() => handleAiAnnouncement(i)} className="text-purple-400 hover:text-purple-600 transition-colors p-1"><Icon name="message-square-text" size={14}/></button>}
                                                            </div>
                                                        )}
                                                    </div>
                                                </th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {filteredActivities.length > 0 ? filteredActivities.map((act) => {
                                            const globalIdx = act.originalIndex;
                                            const count = act.data.filter(c => c === 'O').length;
                                            return (
                                                <tr key={act.id} className="hover:bg-blue-50/30 transition-colors">
                                                    <td className="sticky-col-1 px-6 py-3 font-bold text-slate-800 border-r border-b">
                                                        <div className="flex justify-between items-center gap-2">
                                                            {editingActIndex === globalIdx ? (
                                                                <div className="flex items-center gap-2 w-full"><input className="flex-1 p-1 border rounded text-sm outline-none focus:ring-2 focus:ring-blue-400" value={editingActValue} onChange={e => setEditingActValue(e.target.value)} autoFocus /><button onClick={saveActivityName} className="text-emerald-600 p-1 hover:bg-emerald-50 rounded"><Icon name="check" size={16}/></button></div>
                                                            ) : (
                                                                <><span className="truncate">{act.name}</span>{showManager && <div className="flex items-center gap-1 shrink-0 admin-controls"><button onClick={() => startEditActivity(globalIdx, act.name)} className="admin-btn text-blue-400 hover:text-blue-600 p-1.5 rounded" title="編輯名稱"><Icon name="pencil" size={14}/></button><button onClick={() => onDeleteActivityClick(globalIdx)} className="admin-btn text-red-500 hover:text-red-700 p-1.5 rounded" title="刪除活動"><Icon name="trash-2" size={14}/></button></div>}</>
                                                            )}
                                                        </div>
                                                    </td>
                                                    <td className="sticky-col-2 px-5 py-3 border-r border-b group-hover:bg-blue-50/10" style={{ left: colWidths.name }}><span className={`text-xs px-3 py-1 border rounded-full font-bold shadow-sm ${getCategoryColor(act.category)}`}>{act.category}</span></td>
                                                    <td className="sticky-col-3 px-5 py-3 border-r-2 border-b text-center font-black text-blue-600 group-hover:bg-blue-50/20" style={{ left: colWidths.name + colWidths.category }}>{count}</td>
                                                    {act.data.map((cell, cIdx) => {
                                                        const isNew = showManager && cell === 'O' && (!editSnapshot || !editSnapshot[act.id] || editSnapshot[act.id][cIdx] !== 'O');
                                                        const checkColorClass = getCheckColorClass(act, cIdx, isNew, act.category);
                                                        return (
                                                            <td key={cIdx} onClick={() => toggleStatusClick(globalIdx, cIdx)} className={`px-5 py-3 text-center border-r border-b last:border-r-0 ${showManager ? 'cursor-pointer hover:bg-blue-100' : 'cursor-default'}`}>
                                                                {cell === 'O' ? <div className="flex justify-center animate-in zoom-in duration-200"><Icon name="check-circle-2" size={22} className={checkColorClass} /></div> : <span className="text-slate-200">—</span>}
                                                            </td>
                                                        );
                                                    })}
                                                </tr>
                                            );
                                        }) : <tr><td colSpan={dates.length+3} className="px-6 py-24 text-center text-slate-400 italic">無符合項目</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                        {confirmConfig.show && <ConfirmModal title={confirmConfig.title} message={confirmConfig.message} confirmText={confirmConfig.confirmText} confirmColor={confirmConfig.confirmColor} onConfirm={handleConfirmAction} onCancel={() => setConfirmConfig({...confirmConfig, show: false})} />}
                        {showAiModal && <div className="fixed inset-0 z-[300] flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-in fade-in duration-200"><div className="bg-white rounded-3xl shadow-2xl w-full max-w-2xl overflow-hidden border border-slate-200 animate-in zoom-in duration-300"><div className="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 flex justify-between items-center text-white font-bold"><div className="flex items-center gap-3"><Icon name="sparkles" size={24} /> <span className="text-xl">AI 創意助手</span></div><button onClick={() => setShowAiModal(false)} className="hover:bg-white/20 p-2 rounded-full clickable-btn"><Icon name="x" size={24} /></button></div><div className="p-8 bg-slate-50 max-h-[65vh] overflow-y-auto">{isAiLoading ? <p className="text-center text-slate-500 font-bold animate-pulse py-10">AI 正在思考中...</p> : <div className="whitespace-pre-line leading-relaxed text-slate-700 bg-white p-8 rounded-2xl border shadow-sm">{aiResult}</div>}</div><div className="p-5 bg-white border-t flex justify-end"><button onClick={() => setShowAiModal(false)} className="bg-slate-800 text-white px-10 py-3 rounded-2xl font-bold clickable-btn">關閉</button></div></div></div>}
                        {showKeyInput && <div className="fixed inset-0 z-[300] flex items-center justify-center bg-black/50 p-4"><div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-md"><h3 className="text-xl font-bold mb-4">設定 Gemini API Key</h3><input ref={keyInputRef} type="password" placeholder="貼上 API Key..." className="w-full p-3 border rounded-xl mb-4 outline-none focus:ring-2 focus:ring-blue-500" onKeyDown={(e) => {if(e.key === 'Enter') saveApiKey(e.target.value)}} /><div className="flex justify-end gap-2"><button onClick={() => setShowKeyInput(false)} className="px-4 py-2 text-slate-500 clickable-btn">取消</button><button onClick={() => saveApiKey(keyInputRef.current?.value || "")} className="px-4 py-2 bg-blue-600 text-white rounded-lg clickable-btn">儲存</button></div></div></div>}
                        <div className="mt-10 text-center text-slate-400 text-sm">© 2025 活動管理系統 - 視覺邏輯升級版</div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>